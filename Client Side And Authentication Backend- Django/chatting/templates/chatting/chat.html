<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.5/ace.js"></script>
    <!-- Core build with no theme, formatting, non-essential modules -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
      integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />

    <style type="text/css" media="screen">
      #codeWrapper {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 50%;
      }
      #outputScreen {
        height: 28%;
      }
      #codeEditor {
        height: 66%;
      }
      #textWrapper {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 50%;
        margin-left: 50%;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div class="contain" id="codeWrapper">
      <nav
        class="navbar navbar-expand-sm navbar-dark bg-dark "
        style="width:100%; height: 3%;"
      >
        <li class="nav-item">
          <a class="navbar-brand" href="#">Code Share</a>
        </li>

        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              href="#"
              id="navbarDropdown"
              role="button"
              data-toggle="dropdown"
              aria-haspopup="true"
              aria-expanded="false"
            >
              Language
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
              <a class="dropdown-item" href="#" onclick="changeLang('python')"
                >Python</a
              >
              <a class="dropdown-item" href="#" onclick="changeLang('java')"
                >Java</a
              >
              <a class="dropdown-item" href="#" onclick="changeLang('cpp')"
                >C++</a
              >
              <a class="dropdown-item" href="#" onclick="changeLang('c')">C</a>
            </div>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" style="margin-left: 800%">Submit</a>
          </li>
          <!-- <li class="nav-item">
              <a class="nav-link" href="#">Link</a>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" href="#">Disabled</a>
            </li> -->
        </ul>
      </nav>
      <div id="codeEditor"></div>
      <nav
        class="navbar navbar-expand-sm bg-dark navbar-dark"
        style="width:100%; height: 3%;"
      >
        <ul class="navbar-nav">
          <li class="nav-item">
            <i
              class="fa fa-spinner fa-spin"
              style="font-size:24px; color: white"
            ></i>
            &nbsp;
            <a class="navbar-brand" href="#">Output Screen</a>
          </li>

          <!-- <li class="nav-item">
              <a class="nav-link disabled" href="#">Disabled</a>
            </li> -->
        </ul>
      </nav>
      <div id="outputScreen"></div>
    </div>
    <div class="contain" id="textWrapper">
      <div id="toolbar">
        <input type="file" id="fileToLoad" />
        <span onclick="loadFileAsText()" style="cursor:pointer"
          ><i style="font-size:24px" class="fas">Import &#xf56e;</i></span
        >
      </div>
      <div id="textEditor"></div>
    </div>
    <!-- <div id="outputScreen"></div> -->

    <script>
      var socket = io.connect("http://localhost:3000/", {
        query: "username={{username}}"
      });

      var java = `/*package whatever //do not write package name here */

            import java.io.*;

            class GFG {
              public static void main (String[] args) {
                System.out.println("GfG!");
              }
            }`;

      var py = `print("Hello")`;

      var cpp = `#include <iostream>
            using namespace std;

            int main() {
              cout<<"GfG!";
              return 0;
            }`;

      var c = `#include <stdio.h>

            int main() {
            //code
            return 0;
            }`;

      var editor = ace.edit("codeEditor");
      editor.setTheme("ace/theme/monokai");
      editor.setOption("indentedSoftWrap", false);
      editor.setShowPrintMargin(false);
      editor.session.setMode("ace/mode/python");
      editor.session.insert(
        {
          row: 0,
          col: 0
        },
        py
      );

      function changeLang(name) {
        editor.session.setMode("ace/mode/" + name);
        var data;
        var mode = name;
        editor.setValue("");
        var pos = {
          row: 0,
          col: 0
        };
        if (name === "python") {
          data = py;
          editor.session.insert(pos, py);
        } else if (name === "java") {
          data = java;
          editor.session.insert(pos, java);
        } else if (name === "cpp") {
          data = cpp;
          editor.session.insert(pos, cpp);
        } else {
          data = c;
          editor.session.insert(pos, c);
        }

        socket.emit("changeSession", {
          currRow: 0,
          currCol: 0,
          data: data,
          mode: mode
        });
      }

      var toolbarOptions = [
        [{ font: [] }],
        ["bold", "italic", "underline"],
        ["blockquote", "code-block"],
        [{ list: "ordered" }, { list: "bullet" }],
        [{ align: [] }]
      ];

      var quill = new Quill("#textEditor", {
        modules: {
          toolbar: toolbarOptions
        },
        theme: "snow"
      });

      var quill1 = new Quill("#outputScreen", {
        modules: {
          toolbar: false
        },
        theme: "snow"
      });

      var currText;
      var lastText;
      var pos;
      var keyCode = -1;

      //Code Editor Share

      // $('#codeEditor').on('keyup', function(e){
      //   //console.log('Key Up')
      //   keyCode=e.keyCode
      //   var currRow=editor.getCursorPosition().row
      //   var currCol=editor.getCursorPosition().column
      //   socket.emit('movCurCode', {
      //   currRow: currRow,
      //   currCol: currCol,
      //   key: keyCode
      // })
      // })
      // function getKeycode(){
      //   $('#codeEditor').on('keyup', function(e){
      //   //console.log('Key Up')
      //   keyCode=e.keyCode
      //   var currRow=editor.getCursorPosition().row
      //   var currCol=editor.getCursorPosition().column
      //   socket.emit('movCurCode', {
      //   currRow: currRow,
      //   currCol: currCol,
      //   key: keyCode
      // })
      // })
      // return keyCode
      // }

      // $('#codeEditor').on('keydown', function(e){

      //   if(e.keyCode!==13)
      //   {
      //     console.log('Cursor move+ Backspace')
      //     keyCode=e.keyCode
      //     var currRow=editor.getCursorPosition().row
      //     var currCol=editor.getCursorPosition().column
      //     socket.emit('movCurCode', {
      //     currRow: currRow,
      //     currCol: currCol
      //     })
      //   }
      // })

      $("#codeEditor").on("keyup", function(e) {
        if (
          e.keyCode === 9 ||
          e.keyCode === 13 ||
          e.keyCode === 8 ||
          e.keyCode === 46 ||
          e.keyCode === 40 ||
          e.keyCode === 38 ||
          e.keyCode === 39 ||
          e.keyCode === 37
        ) {
          console.log("Tab + Up + Down + LSide + RSide + Backspace + Del");
          keyCode = e.keyCode;
          var currRow = editor.getCursorPosition().row;
          var currline = editor.getSelectionRange().start.row;
          var currCol = editor.getCursorPosition().column;
          console.log(currRow + " " + currCol);
          socket.emit("movCurCode", {
            currRow: currRow,
            currCol: currCol,
            keyCode: keyCode,
            data: String(editor.getSession().getValue())
          });
        }
      });

      // $('#codeEditor').on('keyup', function(e){

      //   if(e.keyCode===9 || e.keyCode===8 || e.keyCode===46 || e.keyCode===40 || e.keyCode===38 || e.keyCode===39 || e.keyCode===37){
      //   console.log('Tab + Up + Down + LSide + RSide + Backspace + Del')
      //   keyCode=e.keyCode;
      //   var currRow=editor.getCursorPosition().row;
      //   var currCol=editor.getCursorPosition().column;
      //   socket.emit('movCurCode', {
      //   currRow: currRow,
      //   currCol: currCol,
      //   keyCode: keyCode
      // })
      //   }
      // })
      $("#codeEditor").on("paste", function() {
        var currRow = editor.getCursorPosition().row;
        var currCol = editor.getCursorPosition().column;
        socket.emit("writingCode", {
          currRow: currRow,
          currCol: currCol,
          data: String(editor.getSession().getValue())
        });
      });

      $("#codeEditor").on("input", function(e) {
        //console.log("Writing Code")
        // selectionRange = editor.getSelectionRange();

        // startLine = selectionRange.start.row;
        // endLine = selectionRange.end.row;

        // content = editor.session.getTextRange(selectionRange);
        var currline = editor.getSelectionRange().start.row;
        var wholelinetxt = editor.session.getLine(currline);
        //console.log(content)
        var currRow = editor.getCursorPosition().row;
        var currCol = editor.getCursorPosition().column;

        //var wholelinetxt = editor.session.getLine(currRow);

        if (currCol !== 0) var currChar = wholelinetxt.charAt(currCol - 1);
        else var currChar = "";

        // console.log(wholelinetxt+ " "+(currRow+1)+" "+currCol+ " "+currChar);

        //console.log(keyC)
        socket.emit("writingCode", {
          currRow: currRow,
          currCol: currCol,
          data: String(editor.getSession().getValue())
        });
      });

      // $('#codeEditor').on('keyup', function(e){
      //   console.log("Moving Cursor")
      //   var currRow=editor.getCursorPosition().row
      //   var currCol=editor.getCursorPosition().column
      //   socket.emit('movCurCode', {
      //   currRow: currRow,
      //   currCol: currCol
      // })
      // })

      socket.on("writingCode", function(data) {
        var makePos = {
          row: data.currRow + 1,
          col: data.currCol
        };
        console.log(editor.getCursorPosition());
        // console.log(makePos)
        // if(data.enter===1){
        //   console.log("Enter")
        //   editor.session.insert({
        //   row: (data.currRow-1),
        //   col: data.currCol
        // }, "\n");
        // }
        editor.setValue("");
        editor.session.insert(
          {
            row: 0,
            col: 0
          },
          data.data
        );
      });

      socket.on("changeSession", function(data) {
        editor.setValue("");
        editor.session.insert(
          {
            row: 0,
            col: 0
          },
          data.data
        );
        editor.session.setMode("ace/mode/" + data.mode);
      });

      socket.on("movCurCode", function(data) {
        if (data.keyCode === 13) {
          editor.gotoLine(data.currRow + 1, data.currCol);
        } else if (data.keyCode === 9) {
          editor.session.insert(
            {
              row: data.currRow,
              col: data.currCol
            },
            "    "
          );
        } else if (data.keyCode === 8) {
          // console.log(data.currRow+" "+data.currCol+" "+(editor.session.getLine(0).length)-1)
          // if(data.currCol===0 && data.currRow!==0){
          //   editor.gotoLine((data.currRow+1), data.currCol);
          //   console.log("Removed Row");
          // }
          // else{

          //   editor.session.replace({
          //     row: data.currRow,
          //     col: (editor.session.getLine(data.currRow).length)-1
          //   }, "");
          // }

          editor.setValue("");
          editor.session.insert(
            {
              row: 0,
              col: 0
            },
            data.data
          );
        } else if (data.keyCode === 38) {
          // if(data.currRow===0){
          //   console.log("No Rows Above")
          // }
          // else {
          editor.gotoLine(data.currRow + 1, data.currCol);
          // }
        } else if (data.keyCode === 40) {
          // if(!data.currRow){
          //   console.log("No Rows Down")
          // }
          // else {
          editor.gotoLine(data.currRow + 1, data.currCol);
          // }
        } else if (data.keyCode === 37) {
          // if(data.currCol===0 && (data.currRow)!==0){
          //   editor.gotoLine(data.currRow-1, (editor.session.getLine(data.currRow-1).length)-1);

          // }
          // else if(data.currCol===0 && (data.currRow)===0){
          //   console.log("No Col and rows left")
          // }
          // else {
          editor.gotoLine(data.currRow + 1, data.currCol);
          // }
        } else if (data.keyCode === 39) {
          // if(data.currCol=== (editor.session.getLine(data.currRow).length)-1){
          //   editor.gotoLine(data.currRow+1, 0);
          // }
          // else {
          editor.gotoLine(data.currRow + 1, data.currCol);
          // }
        } else if (data.currCol === 46) {
          //   editor.session.replace({
          //   row: data.currRow,
          //   col: data.currCol+1
          // }, "");
          editor.setValue("");
          editor.session.insert(
            {
              row: 0,
              col: 0
            },
            data.data
          );
        }
      });

      $("#textEditor").on("keyup", function(e) {
        if (
          e.keyCode === 9 ||
          e.keyCode === 13 ||
          e.keyCode === 8 ||
          e.keyCode === 46 ||
          e.keyCode === 40 ||
          e.keyCode === 38 ||
          e.keyCode === 39 ||
          e.keyCode === 37
        ) {
          console.log("Tab + Up + Down + LSide + RSide + Backspace + Del");
          keyCode = e.keyCode;
          var range = quill.getSelection();
          var index = range.index;

          console.log(index);
          socket.emit("movCurText", {
            index: index,
            keyCode: e.keyCode,
            data: String(quill.getText()),
            format: quill.getFormat()
          });
        }
      });

      $("#textEditor").on("input", function() {
        console.log(quill.getFormat());
        socket.emit("writingText", {
          data: String(quill.getText()),
          format: quill.getFormat()
        });
      });

      $("#textEditor").on("paste", function() {
        console.log(quill.getFormat());
        socket.emit("writingText", {
          data: String(quill.getText()),
          format: quill.getFormat()
        });
      });

      socket.on("writingText", function(data) {
        quill.setContents([{ insert: "\n" }]);
        quill.setContents({
          ops: [{ insert: data.data }]
        });
      });

      socket.on("movCurText", function(data) {
        if (data.keyCode === 13) {
          quill.setContents([{ insert: "\n" }]);
          quill.setContents({
            ops: [{ insert: data.data }]
          });
        } else if (data.keyCode === 9) {
          quill.setContents([{ insert: "\n" }]);
          quill.setContents({
            ops: [{ insert: data.data }]
          });
        } else if (data.keyCode === 8) {
          quill.setContents([{ insert: "\n" }]);
          quill.setContents({
            ops: [{ insert: data.data }]
          });
        } else if (data.keyCode === 38) {
          quill.setSelection(data.index);
        } else if (data.keyCode === 40) {
          quill.setSelection(data.index);
        } else if (data.keyCode === 37) {
          quill.setSelection(data.index);
        } else if (data.keyCode === 39) {
          quill.setSelection(data.index);
        } else if (data.currCol === 46) {
          quill.setContents([{ insert: "\n" }]);
          quill.setContents({
            ops: [{ insert: data.data }]
          });
        }
      });
    </script>
  </body>
  <script>
    //  document.getElementById('fileid').addEventListener('change', function(e){
    //   var input =e.target;
    //   console.log(input);
    //    reader=new FileReader();

    //      console.log('loaded')
    //     var text = reader.result;
    //     console.log(text)
    //     var node = document.getElementById('#textEditor');
    //     console.log(text)
    //     socket.emit('paste', {
    //       data: reader.readAsText(input.files[0])
    //     })

    //   reader.readAsText(input.files[0]);

    //  })

    function loadFileAsText() {
      var fileToLoad = document.getElementById("fileToLoad").files[0];
      console.log(fileToLoad);
      var fileReader = new FileReader();
      console.log(fileReader);
      fileReader.onload = function(fileLoadedEvent) {
        var textFromFileLoaded = fileLoadedEvent.target.result;
        console.log(textFromFileLoaded);
        socket.emit("writingText", {
          data: textFromFileLoaded
        });
        //quill.setContents([{ insert: '\n' }]);
        quill.setContents({
          ops: [{ insert: textFromFileLoaded }]
        });
      };

      var text = fileReader.readAsText(fileToLoad, "UTF-8");
      console.log(text);
    }
  </script>
</html>

<!-- 
  //  editor.gotoLine(row, column); 


  // console.log("keypos");
  // console.log(editor.getCursorPosition().row);
  // console.log(editor.getCursorPosition().column);
  // const selectedContent = editor.getSelectedText();
  // const range = editor.selection.getRange();
  // console.log(selectedContent + " " + range);
  // editor.session.replace(range, selectedContent);
  // console.log(m.getCursor().column);

  // if (lastText) {
  //   var curr = String(editor.getSession().getValue());
  //   value = curr.substr(lastText.length, curr.length);
  //   lastText = curr;
  // } else {
  //   lastText = editor.getSession().getValue();
  //   value = lastText;
  // } -->

<!-- // // if (e.keyCode === 86 && e.ctrlKey) { // editor.setValue(""); // alert("You
  are not allowed to paste!!"); // } else if (e.keyCode === 88 && e.ctrlKey) { //
  console.log("cut"); // range = editor.selection.getRange(); //
  socket.emit("writing", { // range: range, // selectedContent: "", // value: "",
  // row: editor.getCursorPosition().row, // column:
  editor.getCursorPosition().column, // code: 3 // }); // range = ""; // } // if
  (e.keyCode == 67 && e.ctrlKey) { // selectedContent = editor.getSelectedText();
  // range = editor.selection.getRange(); // } else if (e.keyCode == 86 &&
  e.ctrlKey) { // console.log("paste"); // socket.emit("writing", { // range:
  range, // selectedContent: selectedContent, // value: "", // row:
  editor.getCursorPosition().row, // column: editor.getCursorPosition().column, //
  code: 1 // }); // selectedContent = ""; // range = ""; // } else { // if
  (lastText) { // var curr = String(editor.getSession().getValue()); // value =
  curr.substr(lastText.length, curr.length); // lastText = curr; // } else { //
  lastText = editor.getSession().getValue(); // value = lastText; // } //
  socket.emit("writing", { // range: range, // selectedContent: "", // value:
  value, // row: editor.getCursorPosition().row, // column:
  editor.getCursorPosition().column, // code: 0 // }); // }); -->

<!-- <script>
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        // editor.setOption("indentedSoftWrap", false);
        editor.setShowPrintMargin(false);
        editor.session.setMode("ace/mode/python");

        var lastText = "";
        var value;
        var username = "{{username}}";
        var selectedContent;
        var range;
        console.log(username);
        //Make connection
        // const c=require('opencv4nodejs');
        //var socket = io.connect("http://localhost:3000/");
        var socket = io.connect("http://localhost:3000/", {
          query: "username={{username}}"
        });

        var message = document.getElementById("editor");
        //Onchange
        message.addEventListener("keyup", function(e) {
          console.log(lastText + " " + String(editor.getSession().getValue()));

          // socket.emit("cursorChange", {
          //   row: editor.getCursorPosition().row,
          //   col: editor.getCursorPosition().column
          // });

          editor.on("copy", function() {
            selectedContent = editor.getSelectedText();
            range = editor.selection.getRange();
            console.log("inside copy");
          });

          editor.on("paste", function() {
            socket.emit("writing", {
              range: "",
              selectedContent: selectedContent,
              value: "",
              row: editor.getCursorPosition().row,
              column: editor.getCursorPosition().column,
              code: 1
            });
            selectedContent = "";
            range = "";
          });

          editor.on("change", function() {
            console.log("writing");

            if (lastText) {
              var curr = String(editor.getSession().getValue());
              value = curr.substr(lastText.length, curr.length);
              lastText = curr;
              curr = "";
            } else {
              lastText = editor.getSession().getValue();
              value = lastText;
            }

            socket.emit("writing", {
              range: "",
              selectedContent: "",
              value: value,
              row: editor.getCursorPosition().row,
              column: editor.getCursorPosition().column,
              code: 0
            });
            value = "";
          });

          // //Listen to typing
          socket.on("writing", function(data) {
            console.log(data.code);
            var customPosition = {
              row: data.row,
              column: data.column
            };

            if (data.code === 0) {
              console.log("inside" + " " + customPosition + " " + data.value);
              editor.session.insert(customPosition, data.value);
            }
            // } else if (data.code === 3) {
            //   var customPosition = {
            //     row: data.row,
            //     column: data.column
            //   };
            //   editor.session.replace(customPosition, "");
            // } else if (String(data.selectedContent).length > 0) {
            //   console.log("ok pasted");
            //   var customPosition = {
            //     row: data.row,
            //     column: data.column
            //   };
            //   editor.session.insert(data.row, data.selectedContent);
            // } else {
            //   var customPosition = {
            //     row: data.row,
            //     column: data.column
            //   };
            //   editor.session.insert(customPosition, data.value);
            // }
            //editor.session.insert(customPosition, data.data1);
          });

          socket.on("cursorChange", function(data) {
            editor.gotoLine(data.row, data.col);
          });
        });
      </script> -->
<!-- e.target.selectionStart -->
